# Common settings for Bicep deployment pipelines

parameters:
  - name: defaultPool
    type: object
    default:
      vmImage: "ubuntu-latest"
  - name: serviceConnection
    type: string
    default: serviceConnection
  - name: environments
    type: object
    default: []
  - name: actionGroups
    type: object
    default: []
  - name: enableProduction
    type: boolean
    default: false
  - name: runReviewStage
    type: boolean
    default: true
  - name: drInvocation
    type: boolean
    default: false
  - name: skip_environments
    type: object
    default:
      dev: false
      qa: false
      ppr: false
  - name: variableRoot
    type: string
    default: vars
  - name: variables
    type: object
    default:
      includeCommon: true
      includeEnv: true
      includeEnvRegion: false
      includeRegion: true
  - name: variableGroups
    type: object
    default:
      - "Common-Variables"
  - name: validation
    type: object
    default:
      enableVariableIncludes: true
  - name: additionalRepositories
    type: object
    default: []
  - name: keyVault
    type: object
    default:
      name: ""
      secretsFilter: ""

extends:
  template: /templates/pipeline-dispatcher.yml@PipelineDispatcher
  parameters:
    configuration:
      ${{ each parameter in parameters }}:
        ${{ if not(in(parameter.key, 'skip_environments', 'environments')) }}:
          ${{ parameter.key }}: ${{ parameter.value }}
      ${{ if ne(length(parameters.environments), 0) }}:
        environments:
          - name: dev
            class: development
            dependsOnSecondaryRegions: false
            primaryRegion: weu
            secondaryRegions:
              - neu
            drRegion: neu
            allowedBranches:
              - "*"
            pool:
              vmImage: "ubuntu-latest"
            skipEnvironment: ${{ parameters.skip_environments.dev }}
            poolRegionDemand: false
          - name: qa
            class: test
            dependsOnSecondaryRegions: false
            primaryRegion: weu
            allowedBranches:
              - "main"
              - "release/*"
            pool:
              vmImage: "ubuntu-latest"
            skipEnvironment: ${{ parameters.skip_environments.qa }}
            poolRegionDemand: false
          - name: ppr
            class: acceptance
            dependsOnSecondaryRegions: false
            primaryRegion: weu
            secondaryRegions:
              - neu
            allowedBranches:
              - "main"
              - "release/*"
            pool:
              vmImage: "ubuntu-latest"
            skipEnvironment: ${{ parameters.skip_environments.ppr }}
            poolRegionDemand: false
          - name: prd
            class: production
            primaryRegion: weu
            secondaryRegions:
              - neu
            drRegion: neu
            allowedBranches:
              - "release/*"
            pool:
              vmImage: "ubuntu-latest"
            poolRegionDemand: true
      ${{ else }}:
        environments: ${{ parameters.environments }}
